<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> FormData对象和上传进度条 · gaochen</title><meta name="description" content="FormData对象和上传进度条 - gaochen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/gaochen" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">FormData对象和上传进度条</h1><div class="post-time">Aug 23, 2016</div><div class="post-content"><h3 id="FormData对象"><a href="#FormData对象" class="headerlink" title="FormData对象"></a>FormData对象</h3><p>FormData是XMLHttpRequest Level 2的一个新功能。利用FormData对象可以使用一系列的键值对来模拟一个完整的表单，然后使用XMLHttpRequest发送这个”表单”。</p>
<p><strong>如何使用FormData对象：</strong><br><a id="more"></a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义一个FormData对象</span></span><br><span class="line"><span class="keyword">var</span> oMyForm = <span class="keyword">new</span> FormData();</span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以用已有的form表单来初始化一个FormData对象，然后在form表单的数据基础之上继续添加数据</span></span><br><span class="line"><span class="keyword">var</span> oForm = <span class="built_in">document</span>.getElementById(<span class="string">"form"</span>);</span><br><span class="line"><span class="keyword">var</span> oMyForm1 = <span class="keyword">new</span> FormData(oForm);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过append()方法向FormData对象添加属性</span></span><br><span class="line">oMyForm.append(<span class="string">"username"</span>, <span class="string">"Groucho"</span>);</span><br><span class="line">oMyForm1.append(<span class="string">"accountnum"</span>, <span class="number">123456</span>);   <span class="comment">// 数字123456会被转换为字符串类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//发送FormData对象</span></span><br><span class="line"><span class="keyword">var</span> oReq = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">oReq.open(<span class="string">"POST"</span>, <span class="string">"http://foo.com/submitform.php"</span>);</span><br><span class="line">oReq.send(oMyForm);</span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以使用JQuery来发送FormData</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    url: xxx,</span><br><span class="line">    type: <span class="string">"post"</span>,</span><br><span class="line">    data: oMyForm1,</span><br><span class="line">    processData: <span class="literal">false</span>,  <span class="comment">// 告诉jQuery不要去处理发送的数据</span></span><br><span class="line">    contentType: <span class="literal">false</span>   <span class="comment">// 告诉jQuery不要去设置Content-Type请求头</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="进度条"><a href="#进度条" class="headerlink" title="进度条"></a>进度条</h3><p>XMLHttpRequest Level 2还提供了一个progress事件，用来返回进度信息。它分成上传和下载两种情况。下载的progress事件属于XMLHttpRequest对象，上传的progress事件属于XMLHttpRequest.upload对象。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fd = <span class="keyword">new</span> FormData();</span><br><span class="line"></span><br><span class="line">fd.append(<span class="string">"fileToUpload"</span>, <span class="built_in">document</span>.getElementById(<span class="string">'fileToUpload'</span>).files[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line"><span class="comment">//上传过程中绑定事件</span></span><br><span class="line">xhr.upload.addEventListener(<span class="string">"progress"</span>, uploadProgress, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadProgress</span>(<span class="params">evt</span>) </span>&#123;</span><br><span class="line">     <span class="comment">// event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable</span></span><br><span class="line">     <span class="comment">// 不为真，则event.total等于0 </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (evt.lengthComputable) &#123;</span><br><span class="line">        <span class="keyword">var</span> percentComplete = <span class="built_in">Math</span>.round(evt.loaded * <span class="number">100</span> / evt.total);</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'progressNumber'</span>).innerHTML = percentComplete.toString()</span><br><span class="line">         + <span class="string">'%'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'progressNumber'</span>).innerHTML = <span class="string">'unable to compute'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>参考文档：<a href="https://developer.mozilla.org/zh-CN/docs/Web/Guide/Using_FormData_Objects" target="_blank" rel="external">https://developer.mozilla.org/zh-CN/docs/Web/Guide/Using_FormData_Objects</a></p>
<p>参考文章：<a href="http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html</a></p>
</blockquote>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/30/20160830/" class="prev">PREV</a><a href="/2016/08/01/20160801/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">gaochen</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>