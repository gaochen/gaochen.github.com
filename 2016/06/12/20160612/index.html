<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 移动端项目总结 · gaochen</title><meta name="description" content="移动端项目总结 - gaochen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/gaochen" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">移动端项目总结</h1><div class="post-time">Jun 12, 2016</div><div class="post-content"><p>最近在和原生APP那边做混合开发，前端这边需要做一些H5页面嵌套到原生APP里面。本文的内容就是记录这个项目开发中所遇到的问题及解决办法。</p>
<h3 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h3><p><strong>情景：</strong><br><a id="more"></a></p>
<p>页面主要是做图片展示，类似于瀑布流需要往下滑动。如果图片过多，一开始就全部加载的话，会导致页面打开速度很慢，影响用户体验。所以这里使用延迟加载让超出屏幕显示区域的图片暂时不加载。当图片从下方滑动进入屏幕显示区域时才进行加载。</p>
<p><strong>原理：</strong></p>
<ol>
<li><p>将未加载的图片的url存放在html5的data自定义属性当中（根据个人喜好存放）,当图片进入屏幕显示区域时，再获取每个图片对应的url填入到src属性当中。</p>
</li>
<li><p>如何判断页面进入屏幕显示区域：getBoundingClientRect()</p>
</li>
</ol>
<p>这个方法返回一个矩形对象，包含四个属性：left、top、right和bottom。分别表示元素各边与页面上边和左边的距离。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> box=<span class="built_in">document</span>.getElementById(<span class="string">'box'</span>);         <span class="comment">// 获取元素</span></span><br><span class="line">alert(box.getBoundingClientRect().top);         <span class="comment">// 元素上边距离页面上边的距离</span></span><br><span class="line">alert(box.getBoundingClientRect().right);       <span class="comment">// 元素右边距离页面左边的距离</span></span><br><span class="line">alert(box.getBoundingClientRect().bottom);      <span class="comment">// 元素下边距离页面上边的距离</span></span><br><span class="line">alert(box.getBoundingClientRect().left);        <span class="comment">// 元素左边距离页面左边的距离</span></span><br></pre></td></tr></table></figure></p>
<p><strong>实现：</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * [lazyLoad 延迟加载]</span><br><span class="line"> * @param  &#123;[type]&#125; arrImg [图片元素数组]</span><br><span class="line"> * @param  &#123;[type]&#125; h   [屏幕显示区高度]</span><br><span class="line"> * @return &#123;[type]&#125;     [description]</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lazyLoad</span>(<span class="params">arrImg, h</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>, len=arrImg.length; i&lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> _this = arrImg[i];</span><br><span class="line">        <span class="keyword">var</span> src = _this.dataset.src;</span><br><span class="line">        <span class="keyword">var</span> top = _this.getBoundingClientRect().top;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( top &lt; h &amp;&amp; _this.style.backgroundImage === <span class="string">""</span>) &#123;</span><br><span class="line">            _this.style.backgroundImage = <span class="string">"url("</span>+src+<span class="string">")"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="移动端滚动优化"><a href="#移动端滚动优化" class="headerlink" title="移动端滚动优化"></a>移动端滚动优化</h3><p><strong>场景：</strong></p>
<p>H5页面在Safari上的滚动效果差强人意，比原生App的用户体验差很多，因此需要想办法优化滚动条的流畅性。</p>
<p><strong>原理：</strong></p>
<p>CSS的属性-webkit-overflow-scrolling创建了带有硬件加速的系统级控件，所以效率很高。但是这相对是耗更多内存的，最好在产生了非常大面积的overflow时才应用。</p>
<p><strong>实现：</strong><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-webkit-overflow-scrolling</span>: <span class="selector-tag">touch</span>; <span class="comment">/* 当手指从触摸屏上移开，会保持一段时间的滚动 */</span></span><br></pre></td></tr></table></figure></p>
<h3 id="WebView锚点Bug"><a href="#WebView锚点Bug" class="headerlink" title="WebView锚点Bug"></a>WebView锚点Bug</h3><p><strong>场景：</strong></p>
<p>图片分类展示页面有一个需求：通过点击特定标签跳转到相应的分类页面，及跳转到页面的某个特定区域。最开始我选择的方法就是通过设置锚点来定位。</p>
<p><strong>Bug描述：</strong></p>
<p>当进入这个展示页面，在不滑动页面的情况下，锚点定位是起作用的；但是一旦手指滑动页面之后，锚点定位就失效了。这个问题出现在Android设备的WebView上，iOS设备没有测试。</p>
<p><strong>解决办法：</strong></p>
<p>在网上搜索了相关问题，发现没有方法能直接解决锚点问题。于是在这里我改为使用JS来实现定位。即使用offsetTop属性来获取需要定位元素相对于其offsetParent元素的顶部的距离h。然后使用scrollTop属性设置offsetParent元素距离顶部的高度，以此来实现定位效果。</p>
<h3 id="WebView手势冲突"><a href="#WebView手势冲突" class="headerlink" title="WebView手势冲突"></a>WebView手势冲突</h3><p><strong>场景：</strong></p>
<p>某些页面有轮播图效果，通过手指在屏幕上左右滑动来切换图片。但是原生那边有一个效果是手指在WebView的页面上左右滑动会切换整个页面，这两个滑动效果就起冲突了。</p>
<p><strong>Bug描述：</strong></p>
<p>当在轮播图区域左右滑动时，触发的是整个页面的切换，而不是轮播图片的切换。</p>
<p><strong>解决办法：</strong></p>
<p>解决办法是在调用touch事件的时候阻止事件的默认行为，即调用event.preventDefault()。但是这里会产生一个新的问题：由于在轮播图的区域禁止了默认行为，所以不仅会阻止页面的左右滑动，还会阻止页面的上下滑动。因此为了提高用户体验，这里需要做一个判断，用户的手势操作是竖直方向的滑动还是水平方向的滑动。只有当在水平滑动的时候才阻止事件的默认行为。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// touchstart</span></span><br><span class="line"><span class="keyword">var</span> ev = ev.changedTouches[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> iStartTouchX = ev.pageX;    <span class="comment">// 获取初始点的x坐标</span></span><br><span class="line"><span class="keyword">var</span> iStartTouchY = ev.pageY;    <span class="comment">// 获取初始点的y坐标</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// touchmove</span></span><br><span class="line"><span class="keyword">var</span> ev = ev.changedTouches[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> iEndTouchX = ev.pageX;    <span class="comment">// 获取终点的x坐标        </span></span><br><span class="line"><span class="keyword">var</span> iEndTouchY = ev.pageY;    <span class="comment">// 获取终点的y坐标</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 移动距离</span></span><br><span class="line"><span class="keyword">var</span> iDisX = <span class="built_in">Math</span>.abs(iStartTouchX - iEndTouchX);</span><br><span class="line"><span class="keyword">var</span> iDisY = <span class="built_in">Math</span>.abs(iStartTouchY - iEndTouchY);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当横向移动距离大于纵向移动距离时，即为水平方向的滑动</span></span><br><span class="line"><span class="keyword">if</span> (iDisX &gt; iDisY) &#123;</span><br><span class="line">    ev.preventDefault();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注：在低版本的安卓设备上阻止事件的默认行为仍然无法解决手势冲突的问题，需要安卓开发人员写解决方法然后JS调用</p>
<h3 id="屏蔽微信内置浏览器h5页面拨号功能"><a href="#屏蔽微信内置浏览器h5页面拨号功能" class="headerlink" title="屏蔽微信内置浏览器h5页面拨号功能"></a>屏蔽微信内置浏览器h5页面拨号功能</h3><p><strong>场景：</strong></p>
<p>当页面的文本内容包含数字，且格式类似于xx-xxxx的时候，微信内置浏览器会默认加上链接样式，点击后提示是否拨号。</p>
<p><strong>解决办法：</strong><br>在html文件开头加入两个meta标签，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"format-detection"</span> <span class="attr">content</span>=<span class="string">"telephone=no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-rim-auto-match"</span> <span class="attr">content</span>=<span class="string">"none"</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="移动端设备检测"><a href="#移动端设备检测" class="headerlink" title="移动端设备检测"></a>移动端设备检测</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> browser = &#123;</span><br><span class="line">    versions: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> u = navigator.userAgent, app = navigator.appVersion;</span><br><span class="line">        <span class="keyword">return</span> &#123;         <span class="comment">//移动终端浏览器版本信息</span></span><br><span class="line">            trident: u.indexOf(<span class="string">'Trident'</span>) &gt; <span class="number">-1</span>, <span class="comment">//IE内核</span></span><br><span class="line">            presto: u.indexOf(<span class="string">'Presto'</span>) &gt; <span class="number">-1</span>, <span class="comment">//opera内核</span></span><br><span class="line">            webKit: u.indexOf(<span class="string">'AppleWebKit'</span>) &gt; <span class="number">-1</span>, <span class="comment">//苹果、谷歌内核</span></span><br><span class="line">            gecko: u.indexOf(<span class="string">'Gecko'</span>) &gt; <span class="number">-1</span> &amp;&amp; u.indexOf(<span class="string">'KHTML'</span>) == <span class="number">-1</span>, <span class="comment">//火狐内核</span></span><br><span class="line">            mobile: !!u.match(<span class="regexp">/AppleWebKit.*Mobile.*/</span>), <span class="comment">//是否为移动终端</span></span><br><span class="line">            ios: !!u.match(<span class="regexp">/\(i[^;]+;( U;)? CPU.+Mac OS X/</span>), <span class="comment">//ios终端</span></span><br><span class="line">            android: u.indexOf(<span class="string">'Android'</span>) &gt; <span class="number">-1</span> || u.indexOf(<span class="string">'Linux'</span>) &gt; <span class="number">-1</span>, <span class="comment">//android终端</span></span><br><span class="line">                                                                           <span class="comment">//或uc浏览器</span></span><br><span class="line">            iPhone: u.indexOf(<span class="string">'iPhone'</span>) &gt; <span class="number">-1</span>, <span class="comment">//是否为iPhone或者QQHD浏览器</span></span><br><span class="line">            iPad: u.indexOf(<span class="string">'iPad'</span>) &gt; <span class="number">-1</span>, <span class="comment">//是否iPad</span></span><br><span class="line">            webApp: u.indexOf(<span class="string">'Safari'</span>) == <span class="number">-1</span> <span class="comment">//是否web应该程序，没有头部与底部</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;(),</span><br><span class="line">    language: (navigator.browserLanguage || navigator.language).toLowerCase()</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (browser.versions.mobile) &#123;<span class="comment">//判断是否是移动设备打开。browser代码在下面</span></span><br><span class="line">    <span class="keyword">var</span> ua = navigator.userAgent.toLowerCase();<span class="comment">//获取判断用的对象</span></span><br><span class="line">    <span class="keyword">if</span> (ua.match(<span class="regexp">/MicroMessenger/i</span>) == <span class="string">"micromessenger"</span>) &#123;</span><br><span class="line">        <span class="comment">//在微信浏览器打开</span></span><br><span class="line">        alert(<span class="string">"weixin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ua.match(<span class="regexp">/WeiBo/i</span>) == <span class="string">"weibo"</span>) &#123;</span><br><span class="line">        <span class="comment">//在微博浏览器打开</span></span><br><span class="line">        alert(<span class="string">"weibo"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ua.match(<span class="regexp">/QQ/i</span>) == <span class="string">"qq"</span>) &#123;</span><br><span class="line">        <span class="comment">//在QQ空间打开</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (browser.versions.ios) &#123;</span><br><span class="line">        <span class="comment">//是否在IOS浏览器打开</span></span><br><span class="line">        alert(<span class="string">"ios"</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(browser.versions.android)&#123;</span><br><span class="line">        <span class="comment">//是否在安卓浏览器打开</span></span><br><span class="line">        alert(<span class="string">"android"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//否则就是PC浏览器打开</span></span><br><span class="line">        alert(<span class="string">"pc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2016/06/22/20160622/" class="prev">PREV</a><a href="/2016/05/25/20160526/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">gaochen</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>